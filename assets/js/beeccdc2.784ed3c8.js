"use strict";(globalThis.webpackChunkgh_docs=globalThis.webpackChunkgh_docs||[]).push([[6082],{1758(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>t,metadata:()=>d,toc:()=>a});const d=JSON.parse('{"id":"api-reference/notifications","title":"Notifica\xe7\xf5es em Tempo Real","description":"O FinTrack oferece um sistema de notifica\xe7\xf5es em tempo real via Server-Sent Events (SSE). Este endpoint permite que o frontend receba atualiza\xe7\xf5es instant\xe2neas quando dados s\xe3o modificados no workspace, eliminando a necessidade de polling.","source":"@site/docs/api-reference/notifications.md","sourceDirName":"api-reference","slug":"/api-reference/notifications","permalink":"/fintrack-docs/docs/api-reference/notifications","draft":false,"unlisted":false,"editUrl":"https://github.com/PHRaulino-Space/fintrack-docs/tree/main/gh-docs/docs/api-reference/notifications.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"API Keys","permalink":"/fintrack-docs/docs/api-reference/api-keys"},"next":{"title":"Workspaces","permalink":"/fintrack-docs/docs/api-reference/workspaces"}}');var r=s(4848),c=s(8453);const t={},i="Notifica\xe7\xf5es em Tempo Real",o={},a=[{value:"Vis\xe3o Geral",id:"vis\xe3o-geral",level:2},{value:"Endpoint",id:"endpoint",level:2},{value:"Headers de Resposta",id:"headers-de-resposta",level:3},{value:"Formato dos Eventos",id:"formato-dos-eventos",level:2},{value:"Estrutura do Payload",id:"estrutura-do-payload",level:3},{value:"Tipos de Eventos",id:"tipos-de-eventos",level:2},{value:"Eventos de Sistema",id:"eventos-de-sistema",level:3},{value:"Contas e Cart\xf5es",id:"contas-e-cart\xf5es",level:3},{value:"Categoriza\xe7\xe3o",id:"categoriza\xe7\xe3o",level:3},{value:"Transa\xe7\xf5es",id:"transa\xe7\xf5es",level:3},{value:"Investimentos",id:"investimentos",level:3},{value:"Recorr\xeancias",id:"recorr\xeancias",level:3},{value:"Import Sessions",id:"import-sessions",level:3},{value:"Conectando ao Stream",id:"conectando-ao-stream",level:2},{value:"JavaScript/TypeScript",id:"javascripttypescript",level:3},{value:"React Hook",id:"react-hook",level:3},{value:"Uso do Hook",id:"uso-do-hook",level:3},{value:"Comportamento",id:"comportamento",level:2},{value:"Reconex\xe3o Autom\xe1tica",id:"reconex\xe3o-autom\xe1tica",level:3},{value:"Heartbeat",id:"heartbeat",level:3},{value:"Filtragem por Workspace",id:"filtragem-por-workspace",level:3},{value:"Boas Pr\xe1ticas",id:"boas-pr\xe1ticas",level:2},{value:"1. Feche a conex\xe3o quando n\xe3o precisar",id:"1-feche-a-conex\xe3o-quando-n\xe3o-precisar",level:3},{value:"2. Evite m\xfaltiplas conex\xf5es",id:"2-evite-m\xfaltiplas-conex\xf5es",level:3},{value:"3. Refetch seletivo",id:"3-refetch-seletivo",level:3},{value:"4. Debounce para m\xfaltiplos eventos",id:"4-debounce-para-m\xfaltiplos-eventos",level:3},{value:"Entidades Monitoradas",id:"entidades-monitoradas",level:2},{value:"C\xf3digos de Erro",id:"c\xf3digos-de-erro",level:2}];function l(e){const n={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"notifica\xe7\xf5es-em-tempo-real",children:"Notifica\xe7\xf5es em Tempo Real"})}),"\n",(0,r.jsxs)(n.p,{children:["O FinTrack oferece um sistema de notifica\xe7\xf5es em tempo real via ",(0,r.jsx)(n.strong,{children:"Server-Sent Events (SSE)"}),". Este endpoint permite que o frontend receba atualiza\xe7\xf5es instant\xe2neas quando dados s\xe3o modificados no workspace, eliminando a necessidade de polling."]}),"\n",(0,r.jsx)(n.h2,{id:"vis\xe3o-geral",children:"Vis\xe3o Geral"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"PostgreSQL Trigger \u2192 pg_notify() \u2192 SSE Handler \u2192 Frontend\n"})}),"\n",(0,r.jsx)(n.p,{children:"Quando uma entidade \xe9 criada, atualizada ou deletada no banco de dados, um trigger PostgreSQL dispara uma notifica\xe7\xe3o que \xe9 enviada instantaneamente para todos os clientes conectados ao workspace."}),"\n",(0,r.jsx)(n.h2,{id:"endpoint",children:"Endpoint"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"M\xe9todo:"})," ",(0,r.jsx)(n.code,{children:"GET"}),"\n",(0,r.jsx)(n.strong,{children:"Rota:"})," ",(0,r.jsx)(n.code,{children:"/notifications/stream"}),"\n",(0,r.jsx)(n.strong,{children:"Autentica\xe7\xe3o:"})," JWT (Cookie ou Bearer Token)\n",(0,r.jsx)(n.strong,{children:"Header Obrigat\xf3rio:"})," ",(0,r.jsx)(n.code,{children:"X-Workspace-ID"})]}),"\n",(0,r.jsx)(n.h3,{id:"headers-de-resposta",children:"Headers de Resposta"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"Content-Type: text/event-stream\nCache-Control: no-cache\nConnection: keep-alive\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"formato-dos-eventos",children:"Formato dos Eventos"}),"\n",(0,r.jsx)(n.p,{children:"Todos os eventos seguem o formato SSE padr\xe3o:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"event: <event_type>\ndata: <json_payload>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"estrutura-do-payload",children:"Estrutura do Payload"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "event_type": "account.updated",\n  "workspace_id": "550e8400-e29b-41d4-a716-446655440000",\n  "payload": {\n    "id": "660e8400-e29b-41d4-a716-446655440001"\n  },\n  "timestamp": "2024-01-15T10:30:00Z"\n}\n'})}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Campo"}),(0,r.jsx)(n.th,{children:"Tipo"}),(0,r.jsx)(n.th,{children:"Descri\xe7\xe3o"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"event_type"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsxs)(n.td,{children:["Tipo do evento (ex: ",(0,r.jsx)(n.code,{children:"account.created"}),")"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"workspace_id"})}),(0,r.jsx)(n.td,{children:"UUID"}),(0,r.jsx)(n.td,{children:"ID do workspace onde ocorreu a mudan\xe7a"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"payload"})}),(0,r.jsx)(n.td,{children:"object"}),(0,r.jsx)(n.td,{children:"Dados espec\xedficos do evento"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"timestamp"})}),(0,r.jsx)(n.td,{children:"string"}),(0,r.jsx)(n.td,{children:"Data/hora do evento (ISO 8601)"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"tipos-de-eventos",children:"Tipos de Eventos"}),"\n",(0,r.jsx)(n.h3,{id:"eventos-de-sistema",children:"Eventos de Sistema"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Descri\xe7\xe3o"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"connected"})}),(0,r.jsx)(n.td,{children:"Conex\xe3o estabelecida"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{workspace_id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"heartbeat"})}),(0,r.jsx)(n.td,{children:"Keep-alive (a cada 10s)"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{ts}"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"contas-e-cart\xf5es",children:"Contas e Cart\xf5es"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Trigger"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"account.created"})}),(0,r.jsx)(n.td,{children:"INSERT em accounts"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"account.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em accounts"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"account.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em accounts"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"card.created"})}),(0,r.jsx)(n.td,{children:"INSERT em cards"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"card.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em cards"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"card.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em cards"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"invoice.created"})}),(0,r.jsx)(n.td,{children:"INSERT em invoices"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"invoice.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em invoices"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"categoriza\xe7\xe3o",children:"Categoriza\xe7\xe3o"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Trigger"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"category.created"})}),(0,r.jsx)(n.td,{children:"INSERT em categories"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"category.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em categories"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"category.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em categories"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"subcategory.created"})}),(0,r.jsx)(n.td,{children:"INSERT em subcategories"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"subcategory.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em subcategories"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"subcategory.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em subcategories"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"tag.created"})}),(0,r.jsx)(n.td,{children:"INSERT em tags"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"tag.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em tags"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"tag.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em tags"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"transa\xe7\xf5es",children:"Transa\xe7\xf5es"}),"\n",(0,r.jsxs)(n.p,{children:["Todos os eventos de transa\xe7\xe3o incluem o campo ",(0,r.jsx)(n.code,{children:"type"})," no payload para identificar o tipo espec\xedfico."]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Trigger"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"transaction.created"})}),(0,r.jsx)(n.td,{children:"INSERT em tabelas de transa\xe7\xe3o"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, type}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"transaction.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em tabelas de transa\xe7\xe3o"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, type}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"transaction.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em tabelas de transa\xe7\xe3o"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, type}"})})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Valores poss\xedveis para ",(0,r.jsx)(n.code,{children:"type"}),":"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"income"})," - Receitas"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"expense"})," - Despesas"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"transfer"})," - Transfer\xeancias"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"card_expense"})," - Despesas de cart\xe3o"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"card_chargeback"})," - Estornos de cart\xe3o"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"card_payment"})," - Pagamentos de fatura"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"investment_deposit"})," - Aportes em investimentos"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"investment_withdrawal"})," - Resgates de investimentos"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"investimentos",children:"Investimentos"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Trigger"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"investment.created"})}),(0,r.jsx)(n.td,{children:"INSERT em investments"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"investment.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em investments"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"investment.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em investments"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"recorr\xeancias",children:"Recorr\xeancias"}),"\n",(0,r.jsxs)(n.p,{children:["Eventos de recorr\xeancia incluem o campo ",(0,r.jsx)(n.code,{children:"type"})," para identificar o tipo."]}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Trigger"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"recurring.created"})}),(0,r.jsx)(n.td,{children:"INSERT em recurring_*"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, type}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"recurring.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em recurring_*"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, type}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"recurring.deleted"})}),(0,r.jsx)(n.td,{children:"DELETE em recurring_*"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, type}"})})]})]})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Valores poss\xedveis para ",(0,r.jsx)(n.code,{children:"type"}),":"]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"income"})," - Receita recorrente"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"expense"})," - Despesa recorrente"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"transfer"})," - Transfer\xeancia recorrente"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"card_transaction"})," - Transa\xe7\xe3o de cart\xe3o recorrente"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"import-sessions",children:"Import Sessions"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Evento"}),(0,r.jsx)(n.th,{children:"Trigger"}),(0,r.jsx)(n.th,{children:"Payload"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"import_session.created"})}),(0,r.jsx)(n.td,{children:"INSERT em import_sessions"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"import_session.updated"})}),(0,r.jsx)(n.td,{children:"UPDATE em import_sessions"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id}"})})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"staged_tx.status_changed"})}),(0,r.jsx)(n.td,{children:"UPDATE de status em staged_transactions"}),(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"{id, session_id, status}"})})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"conectando-ao-stream",children:"Conectando ao Stream"}),"\n",(0,r.jsx)(n.h3,{id:"javascripttypescript",children:"JavaScript/TypeScript"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"const workspaceId = 'seu-workspace-id';\nconst url = `${API_BASE_URL}/v1/notifications/stream`;\n\nconst eventSource = new EventSource(url, {\n  withCredentials: true  // Envia cookies de autentica\xe7\xe3o\n});\n\n// Evento de conex\xe3o estabelecida\neventSource.addEventListener('connected', (e) => {\n  const data = JSON.parse(e.data);\n  console.log('Conectado ao workspace:', data.workspace_id);\n});\n\n// Eventos de entidades\neventSource.addEventListener('account.updated', (e) => {\n  const { payload } = JSON.parse(e.data);\n  console.log('Conta atualizada:', payload.id);\n  // Refetch dos dados da conta\n});\n\neventSource.addEventListener('transaction.created', (e) => {\n  const { payload } = JSON.parse(e.data);\n  console.log('Nova transa\xe7\xe3o:', payload.id, 'tipo:', payload.type);\n  // Atualizar lista de transa\xe7\xf5es\n});\n\n// Heartbeat (keep-alive)\neventSource.addEventListener('heartbeat', (e) => {\n  const { ts } = JSON.parse(e.data);\n  console.log('Heartbeat:', ts);\n});\n\n// Tratamento de erros\neventSource.onerror = (err) => {\n  console.error('Erro na conex\xe3o SSE:', err);\n  // O browser tentar\xe1 reconectar automaticamente\n};\n\n// Fechar conex\xe3o quando n\xe3o precisar mais\n// eventSource.close();\n"})}),"\n",(0,r.jsx)(n.h3,{id:"react-hook",children:"React Hook"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { useEffect, useRef, useCallback } from 'react';\n\ntype EventHandler = (payload: Record<string, unknown>) => void;\n\nexport function useNotifications() {\n  const eventSourceRef = useRef<EventSource | null>(null);\n  const handlersRef = useRef<Map<string, EventHandler[]>>(new Map());\n\n  useEffect(() => {\n    const url = `${process.env.NEXT_PUBLIC_API_URL}/v1/notifications/stream`;\n    const eventSource = new EventSource(url, { withCredentials: true });\n\n    eventSource.onmessage = (e) => {\n      try {\n        const event = JSON.parse(e.data);\n        const handlers = handlersRef.current.get(event.event_type) || [];\n        handlers.forEach(handler => handler(event.payload));\n      } catch (err) {\n        console.error('Erro ao processar notifica\xe7\xe3o:', err);\n      }\n    };\n\n    eventSourceRef.current = eventSource;\n    return () => eventSource.close();\n  }, []);\n\n  const subscribe = useCallback((eventType: string, handler: EventHandler) => {\n    const handlers = handlersRef.current.get(eventType) || [];\n    handlersRef.current.set(eventType, [...handlers, handler]);\n\n    return () => {\n      const updated = handlersRef.current.get(eventType)?.filter(h => h !== handler);\n      handlersRef.current.set(eventType, updated || []);\n    };\n  }, []);\n\n  return { subscribe };\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"uso-do-hook",children:"Uso do Hook"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { useEffect } from 'react';\nimport { useNotifications } from '@/hooks/useNotifications';\nimport { useAccounts } from '@/hooks/useAccounts';\n\nexport default function AccountsPage() {\n  const { data: accounts, refetch } = useAccounts();\n  const { subscribe } = useNotifications();\n\n  useEffect(() => {\n    const unsubscribers = [\n      subscribe('account.created', () => refetch()),\n      subscribe('account.updated', () => refetch()),\n      subscribe('account.deleted', () => refetch()),\n    ];\n\n    return () => unsubscribers.forEach(unsub => unsub());\n  }, [subscribe, refetch]);\n\n  return <AccountsList accounts={accounts} />;\n}\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"comportamento",children:"Comportamento"}),"\n",(0,r.jsx)(n.h3,{id:"reconex\xe3o-autom\xe1tica",children:"Reconex\xe3o Autom\xe1tica"}),"\n",(0,r.jsxs)(n.p,{children:["O browser reconecta automaticamente em caso de perda de conex\xe3o. O SSE mant\xe9m um ",(0,r.jsx)(n.code,{children:"Last-Event-ID"})," para recuperar eventos perdidos (se implementado no servidor)."]}),"\n",(0,r.jsx)(n.h3,{id:"heartbeat",children:"Heartbeat"}),"\n",(0,r.jsxs)(n.p,{children:["O servidor envia um evento ",(0,r.jsx)(n.code,{children:"heartbeat"})," a cada 10 segundos para manter a conex\xe3o ativa e detectar desconex\xf5es."]}),"\n",(0,r.jsx)(n.h3,{id:"filtragem-por-workspace",children:"Filtragem por Workspace"}),"\n",(0,r.jsxs)(n.p,{children:["O servidor filtra automaticamente os eventos pelo ",(0,r.jsx)(n.code,{children:"workspace_id"})," do header ",(0,r.jsx)(n.code,{children:"X-Workspace-ID"}),". Voc\xea s\xf3 receber\xe1 eventos do workspace ao qual est\xe1 conectado."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"boas-pr\xe1ticas",children:"Boas Pr\xe1ticas"}),"\n",(0,r.jsx)(n.h3,{id:"1-feche-a-conex\xe3o-quando-n\xe3o-precisar",children:"1. Feche a conex\xe3o quando n\xe3o precisar"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"useEffect(() => {\n  const eventSource = new EventSource(url);\n\n  return () => {\n    eventSource.close(); // Importante!\n  };\n}, []);\n"})}),"\n",(0,r.jsx)(n.h3,{id:"2-evite-m\xfaltiplas-conex\xf5es",children:"2. Evite m\xfaltiplas conex\xf5es"}),"\n",(0,r.jsx)(n.p,{children:"Mantenha uma \xfanica conex\xe3o SSE por aplica\xe7\xe3o. Use um Context ou Provider para compartilhar."}),"\n",(0,r.jsx)(n.h3,{id:"3-refetch-seletivo",children:"3. Refetch seletivo"}),"\n",(0,r.jsx)(n.p,{children:"Ao receber um evento de atualiza\xe7\xe3o, fa\xe7a refetch apenas do item espec\xedfico quando poss\xedvel:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"subscribe('account.updated', (payload) => {\n  const { id } = payload;\n  queryClient.invalidateQueries(['account', id]);\n});\n"})}),"\n",(0,r.jsx)(n.h3,{id:"4-debounce-para-m\xfaltiplos-eventos",children:"4. Debounce para m\xfaltiplos eventos"}),"\n",(0,r.jsx)(n.p,{children:"Se espera muitos eventos em sequ\xeancia, considere usar debounce:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-typescript",children:"import { debounce } from 'lodash';\n\nconst debouncedRefetch = debounce(() => refetch(), 500);\nsubscribe('transaction.created', debouncedRefetch);\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"entidades-monitoradas",children:"Entidades Monitoradas"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Categoria"}),(0,r.jsx)(n.th,{children:"Tabelas"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Contas"})}),(0,r.jsx)(n.td,{children:"accounts, cards, invoices"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Categoriza\xe7\xe3o"})}),(0,r.jsx)(n.td,{children:"categories, subcategories, tags"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Transa\xe7\xf5es"})}),(0,r.jsx)(n.td,{children:"incomes, expenses, transfers, card_expenses, card_chargebacks, card_payments"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Investimentos"})}),(0,r.jsx)(n.td,{children:"investments, investment_deposits, investment_withdrawals"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Recorr\xeancias"})}),(0,r.jsx)(n.td,{children:"recurring_incomes, recurring_expenses, recurring_transfers, recurring_card_transactions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.strong,{children:"Import"})}),(0,r.jsx)(n.td,{children:"import_sessions, staged_transactions"})]})]})]}),"\n",(0,r.jsxs)(n.admonition,{title:"Entidades n\xe3o monitoradas",type:"note",children:[(0,r.jsxs)(n.p,{children:["As seguintes entidades ",(0,r.jsx)(n.strong,{children:"n\xe3o"})," geram notifica\xe7\xf5es:"]}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"users"})," - Dados sens\xedveis"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"workspace_members"})," - Raramente alterado"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"currencies"})," - Dados de refer\xeancia"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"exchange_rates"})," - Dados de refer\xeancia"]}),"\n"]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"c\xf3digos-de-erro",children:"C\xf3digos de Erro"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"C\xf3digo"}),(0,r.jsx)(n.th,{children:"Descri\xe7\xe3o"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"401 Unauthorized"})}),(0,r.jsx)(n.td,{children:"Token JWT inv\xe1lido ou ausente"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"400 Bad Request"})}),(0,r.jsxs)(n.td,{children:["Header ",(0,r.jsx)(n.code,{children:"X-Workspace-ID"})," ausente"]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"403 Forbidden"})}),(0,r.jsx)(n.td,{children:"Usu\xe1rio n\xe3o pertence ao workspace"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>t,x:()=>i});var d=s(6540);const r={},c=d.createContext(r);function t(e){const n=d.useContext(c);return d.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),d.createElement(c.Provider,{value:n},e.children)}}}]);